#!/bin/bash

flags="-S -ast"

output_dir="output"

compile="java -cp mjc.jar mjc.JVMMain $flags" 
jasmin="jasmin"
build="ant"

inheritence_tests=0 # Set to 1 to test inheritence

compile_tests="student-test-cases/compile/*/*.java"
noncompile_tests="student-test-cases/noncompile/*/*.java minijava_tests/no_inheritence/err_*.java"
execute_tests="student-test-cases/execute/*/*.java minijava_tests/no_inheritence/ok*.java"
nonexecute_tests="student-test-cases/nonexecute/*/*.java"

if [ $inheritence_tests -eq 1 ]; then
	execute_tests="$execute_tests minijava_tests/inheritence/*.java"
fi

###### COLORS
txtblk='\e[0;30m' # Black - Regular
txtred='\e[0;31m' # Red
txtgrn='\e[0;32m' # Green
txtylw='\e[0;33m' # Yellow
txtblu='\e[0;34m' # Blue
txtpur='\e[0;35m' # Purple
txtcyn='\e[0;36m' # Cyan
txtwht='\e[0;37m' # White
bldblk='\e[1;30m' # Black - Bold
bldred='\e[1;31m' # Red
bldgrn='\e[1;32m' # Green
bldylw='\e[1;33m' # Yellow
bldblu='\e[1;34m' # Blue
bldpur='\e[1;35m' # Purple
bldcyn='\e[1;36m' # Cyan
bldwht='\e[1;37m' # White
unkblk='\e[4;30m' # Black - Underline
undred='\e[4;31m' # Red
undgrn='\e[4;32m' # Green
undylw='\e[4;33m' # Yellow
undblu='\e[4;34m' # Blue
undpur='\e[4;35m' # Purple
undcyn='\e[4;36m' # Cyan
undwht='\e[4;37m' # White
bakblk='\e[40m'   # Black - Background
bakred='\e[41m'   # Red
bakgrn='\e[42m'   # Green
bakylw='\e[43m'   # Yellow
bakblu='\e[44m'   # Blue
bakpur='\e[45m'   # Purple
bakcyn='\e[46m'   # Cyan
bakwht='\e[47m'   # White
txtrst='\e[0m'    # Text Reset
##### END COLORS

##Filename to dir
function mkdirname() {
	echo "$1" | sed 's/\.java//g' | tr '[A-Z]' '[a-z]'
}

function build_mjc() {
	echo -ne "Compiling compiler \t"
	res=$($build)
	if [ $? -eq 0 ]; then
		echo -e "$txtgrn OK $txtrst"
		return 0
	else
		echo -e "$txtred ERROR $txtrst"
		echo -e  "$res"
		return 1
	fi
}

## Functions
function compile() {
	_dirname=$(mkdirname $1)
	mkdir -p "$output_dir/$_dirname"
	eval $compile -o "$output_dir/$_dirname" $1 2>&1
}

function extention_list() {
	_lines=$(cat DESC | wc -l)
	tail -n $(($_lines-2)) DESC
}

function test_extentions() {
	_file="$1"
	if [[ $(cat $_file | grep "//.*IGNORE" -c) != "0" ]]; then
		echo -e "$txtylw IGNORE $txtrst"
		return 1
	else
		_extentions=$(cat $_file | grep "//.*EXT" | sed -e 's/\/\/EXT:\(.*\)/\1/')
		for ext in $_extentions; do
			count=$(echo $extentions | grep $ext -cx)
			if [[ $count == "0" ]]; then
				return 1
			fi
		done
		return 0
	fi
}

# Expect compilation of $1 to succed
function compile_ok() {
	_file=$1
	echo -ne "Compiling: $_file \t\t"
	test_extentions $_file
	if [ $? -eq 0 ]; then
		_res=$(compile $_file)
		ex=$?
		if [ $ex -eq 0 ]; then
			echo -e "$txtgrn OK $txtrst"
			return 0
		else
			echo -e "$txtred ERROR $txtrst"
			echo "Compiler output: return status $ex"
			echo -e "$_res\n"
			return 1
		fi
	else
		echo "EXT MISS"
		return 0
	fi
}

#Expect compilation of $1 to fail
function compile_fail() {
	_file=$1
	echo -ne "Compiling: $_file \t\t"
	test_extentions $_file
	if [ $? -eq 0 ]; then
		_res=$(compile $_file)
		ex=$?
		if [ $ex -ne 0 ]; then
			echo -e "$txtgrn OK $txtrst"
			return 0
		else
			echo -e "$txtred ERROR $txtrst"
			return 1
		fi
	else
		echo "EXT MISS"
		return 0
	fi
}

function assemble() {
	_file=$1
	_dirname=$(mkdirname $_file)
	out="$output_dir/$_dirname/bin" 
	mkdir -p "$out"
	echo -en "Assembling: $_file \t\t"
	test_extentions $_file
	
	if [ $? -eq 0 ]; then
		_res=$($jasmin -d "$out" $output_dir/$_dirname/*.j 2>&1)
		if [ -z "$_res" ]; then
			echo -e "$txtgrn OK $txtrst"
			return 0
		else
			echo -e "$txtred ERROR $txtrst"
			echo "Jasmin output: "
			echo -e "$_res\n"
			return 1
		fi
	else
		echo "EXT MISS"
		return 0
	fi
}

# Get the output file for $1
function output_file() {
	_file=$(echo "$1" | sed 's/\.java//g')
	if [ -f "$_file.out" ]; then
		echo "$_file.out"
		return 0
	else 
		if [ -f "$_file.output" ]; then
			echo "$_file.output" 
			return 0
		else
			return 1
		fi
	fi
}

function execute_test() {
	_file=$1
	_dirname=$(mkdirname $_file)
	out="$output_dir/$_dirname/bin" 

	echo -en "Executing: $_file \t\t"
	test_extentions $_file
	
	if [ $? -eq 0 ]; then
		_res=$(java -cp $out Main)
		ex=$?
		if [ $ex -eq 0 ]; then
			_outfile=$(output_file $_file)
			if [ $? -eq 0 ]; then
				_diff=$(echo $_res | diff - "$_outfile")

				if [ $? -eq 0 ]; then 
					echo -e "$txtgrn OK $txtrst"
					return 0
				else
					echo -e "$txtred ERROR $txtrst"
					echo "Diff (program output, expected output):"
					echo -e "$_diff\n"
					return 1
				fi
			else
				echo -e "$txtylw NO OUTPUT DEFINED $txtrst"
				return 0
			fi
		else
			echo -e "$txtred JVM ERROR $txtrst"
			echo "JVM Output:"
			echo -e "$_res\n"
			return 1
		fi
	else
		echo "EXT MISS"
		return 0
	fi
}

## BEGIN EXECUTION

extentions=$(extention_list)

# Set no_exec to 1 in shell to be able to source this file without shit executing!
if [[ $no_exec != "1" ]]; then

build_mjc

if [ $? -ne 0 ]; then
	exit 1
fi

rm -rf $output_dir
mkdir $output_dir

any_error=0

# Start by compiling everything that should be compiled
echo "Compling code"
for file in $(ls $compile_tests $execute_tests $nonexecute_tests); do
	compile_ok $file
	if [ $? -ne 0 ]; then
		any_error=1
	fi
done

if [ $any_error -ne 0 ]; then
	echo "Previous test failed. Not continuing"
	exit 1
fi

echo -e "\n====================================\n"

echo "Compiling code that should fail"

for file in $(ls $noncompile_tests); do
	compile_fail $file
	if [ $? -ne 0 ]; then
		any_error=1
	fi
done

if [ $any_error -ne 0 ]; then
	echo "Previous test failed. Not continuing"
	exit 1
fi

echo -e "\n====================================\n"

echo "Assembling"

for file in $(ls $execute_tests $nonexecute_tests $compile_tests); do
	assemble $file
	if [ $? -ne 0 ]; then
		any_error=1
	fi
done

if [ $any_error -ne 0 ]; then
	echo "Previous test failed. Not continuing"
	exit 1
fi

echo "Running execution test"
for file in $(ls $execute_tests); do
	execute_test $file
	if [ $? -ne 0 ]; then
		any_error=1
	fi
done

fi
